name: Nautilus Model Retrain

on:
  # Run weekly on Sunday at 3 AM UTC
  schedule:
    - cron: '0 3 * * 0'
  # Also allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '15'

permissions:
  contents: read
  packages: write

jobs:
  retrain-recommender:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password123
          POSTGRES_DB: ai321_prod
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Initialize Database
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5432/ai321_prod
        run: |
          python -m src.core.models

      - name: Train Recommender Model
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5432/ai321_prod
        run: |
          EPOCHS="${{ github.event.inputs.epochs || '15' }}"
          python -c "from src.ml.recommender_torch import train_recommender; train_recommender(epochs=${EPOCHS})"

      - name: Upload Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: recommender-model-${{ github.run_id }}
          path: |
            src/models/recommender_torch.pth
            src/models/recommender_ncf.keras
            src/models/recommender_ncf_artifacts.pkl
          retention-days: 30

      - name: Notify Discord (optional)
        if: ${{ always() }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          status="${{ job.status }}"
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          content="ðŸ¤– Model Retrain finished with status: ${status}. Artifacts: ${run_url}"
          if [ -z "$DISCORD_WEBHOOK" ]; then exit 0; fi
          payload=$(printf '{"content":"%s"}' "$content")
          curl -s -X POST "$DISCORD_WEBHOOK" -H "Content-Type: application/json" -d "$payload" || true
